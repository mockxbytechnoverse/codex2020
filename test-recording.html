<!DOCTYPE html>
<html>
<head>
    <title>Test Recording</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        #status { margin: 20px 0; padding: 10px; background: #f0f0f0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Browser Recording</h1>
    <div id="status">Ready to test</div>
    
    <button onclick="testRecording()">Test Recording (5 seconds)</button>
    <button onclick="checkRecordings()">Check Recordings Directory</button>
    <button onclick="testServerConnection()">Test Server Connection</button>
    
    <script>
        let mediaRecorder;
        let recordedChunks = [];
        
        async function testServerConnection() {
            const status = document.getElementById('status');
            try {
                // Try both ports
                for (const port of [3025, 3026]) {
                    status.innerHTML = `Testing server on port ${port}...`;
                    const response = await fetch(`http://localhost:${port}/.identity`);
                    if (response.ok) {
                        const data = await response.json();
                        status.innerHTML = `<span class="success">✓ Server connected on port ${port}: ${JSON.stringify(data)}</span>`;
                        return;
                    }
                }
                status.innerHTML = '<span class="error">✗ Server not responding on ports 3025 or 3026</span>';
            } catch (error) {
                status.innerHTML = `<span class="error">✗ Server connection error: ${error.message}</span>`;
            }
        }
        
        async function testRecording() {
            const status = document.getElementById('status');
            try {
                status.innerHTML = 'Starting recording...';
                
                // Get screen recording
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: false
                });
                
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    status.innerHTML = 'Recording stopped, saving...';
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    
                    // Convert to base64
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64data = reader.result;
                        
                        // Try both ports
                        for (const port of [3025, 3026]) {
                            try {
                                const response = await fetch(`http://localhost:${port}/recording-data`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        data: base64data,
                                        description: 'Test recording',
                                        duration: 5000,
                                        timestamp: Date.now()
                                    })
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    status.innerHTML = `<span class="success">✓ Recording saved! Path: ${result.path}</span>`;
                                    return;
                                }
                            } catch (e) {
                                console.log(`Port ${port} failed:`, e);
                            }
                        }
                        status.innerHTML = '<span class="error">✗ Failed to save recording to server</span>';
                    };
                    reader.readAsDataURL(blob);
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                status.innerHTML = 'Recording for 5 seconds...';
                
                // Stop after 5 seconds
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 5000);
                
            } catch (error) {
                status.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }
        
        async function checkRecordings() {
            const status = document.getElementById('status');
            // Try both ports
            for (const port of [3025, 3026]) {
                try {
                    const response = await fetch(`http://localhost:${port}/recordings`);
                    if (response.ok) {
                        const data = await response.json();
                        status.innerHTML = `<pre>Recordings found: ${data.count}\n${JSON.stringify(data.recordings, null, 2)}</pre>`;
                        return;
                    }
                } catch (e) {
                    console.log(`Port ${port} failed:`, e);
                }
            }
            status.innerHTML = '<span class="error">✗ Could not fetch recordings</span>';
        }
    </script>
</body>
</html>